<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>GPA Calculator</title>
      <link rel="stylesheet" href="index.css">
   </head>

   <script>
        let savedGPAs = {
            // Semester1: {
            //     classNames: ["testingClass1"],
            //     inputtedGPAValues: ["4.0", "4.5", "5.0"],
            //     inputtedGradeValues: [100, 90, 80],
            //     setNumberOfClasses: 3
            // }
        };
        
        /* savedGPAs["name"] = {
            classNames: classNames,
            inputtedGPAValues: inputtedGPAValues,
            inputtedGradeValues: inputtedGradeValues,
            setNumberOfClasses: setNumberOfClasses
        } */ 

        let classNames = [];
        let inputtedGPAValues = [];
        let inputtedGradeValues = [];
        let setNumberOfClasses = 7;

        let selectedSemestersDropDown = [];

        function setTable(numberOfClasses) {
            if(numberOfClasses > 10) numberOfClasses = 10
            if(numberOfClasses < 0) numberOfClasses = 0
            setNumberOfClasses = numberOfClasses
            document.getElementById('numrange').value = numberOfClasses
            document.getElementById('sliderrange').value = numberOfClasses
            createCookie("numOfClasses", setNumberOfClasses, 365)

            let headerRow = document.getElementById('classListRow')
            let gpaRow = document.getElementById('gpaSelectRow')
            let gradeRow = document.getElementById('gradeInputRow')

            headerRow.innerHTML = ''
            gpaRow.innerHTML = ''
            gradeRow.innerHTML = ''

            let corner = document.createElement('th')
            corner.style.borderTop = 'none';
            corner.style.borderLeft = 'none';
            headerRow.appendChild(corner)

            let titleOfGPARow = document.createElement('th')
            titleOfGPARow.style.borderLeft = '1px solid #D8D8D8;';
            titleOfGPARow.innerHTML = 'GPA Weight:'
            gpaRow.appendChild(titleOfGPARow)


            let titleOfGradeRow = document.createElement('th')
            titleOfGradeRow.style.borderLeft = '1px solid #D8D8D8;';
            titleOfGradeRow.innerHTML = 'Current Grades:'
            gradeRow.appendChild(titleOfGradeRow)

            for (let i = 0; i < parseInt(numberOfClasses); i++) {
                // Header (Class 1)
                let headerTH = document.createElement('th')
                let headerInput = document.createElement('input')
                headerInput.className = 'headerClassName'
                headerInput.type = 'text'
                if(!classNames[i]) headerInput.value = 'Class '+Math.floor(i+1)
                else headerInput.value = classNames[i]
                headerInput.onchange = function() {
                    classNames[i] = headerInput.value
                    createCookie("classNames", classNames, 365)
                }
                headerTH.appendChild(headerInput)
                headerRow.appendChild(headerTH)

                // DropDown (5.0)
                let dropDownTD = document.createElement('td')

                let gpaSelector = document.createElement('div')
                gpaSelector.className = "select"

                dropDownTD.appendChild(gpaSelector)
                
                let select = document.createElement('select')
                let options = ['4.0', '4.5', '5.0']
                options.forEach(value => {
                    let opt = document.createElement('option')
                    opt.value = value
                    opt.innerHTML = value
                    select.appendChild(opt)
                });

                select.onchange = function() {
                    inputtedGPAValues[i] = select.value
                    updateGPA()
                }

                if(inputtedGPAValues[i]) select.value = inputtedGPAValues[i]
                
                let arrow = document.createElement('div')
                arrow.className = 'select__arrow'

                gpaSelector.appendChild(select)
                gpaSelector.appendChild(arrow)
                gpaRow.appendChild(dropDownTD)

                // GradeInput (0-100)
                let gradeInputTD = document.createElement('td')
                
                let gradeInput = document.createElement('input')
                gradeInput.className = "gradeInput"
                gradeInput.type = 'number'
                gradeInput.min = 0;
                gradeInput.max = 100;
                gradeInput.value = 0;
                gradeInput.step = 0.5

                if(inputtedGradeValues[i]) gradeInput.value = inputtedGradeValues[i]

                gradeInput.onchange = function() {
                    if(gradeInput.value > 100) gradeInput.value = 100
                    if(gradeInput.value < 0) gradeInput.value = 0
                    inputtedGradeValues[i] = gradeInput.value
                    updateGPA()
                }

                gradeInputTD.appendChild(gradeInput)
                gradeRow.appendChild(gradeInputTD)
            }
        }

        function updateGPA() {
            for (let i = 0; i < parseInt(setNumberOfClasses); i++) {
                if(!inputtedGPAValues[i]) inputtedGPAValues[i] = "4.0"
                if(!inputtedGradeValues[i]) inputtedGradeValues[i] = "0"
            }

            weightedSimples = 0;
            unweightedSimples = 0;
            sumOfGrades = 0;
            totalGPAWeight = 0;
            let headerRow = document.getElementById('classListRow')
            let gpaRow = document.getElementById('gpaSelectRow')
            let gradeRow = document.getElementById('gradeInputRow')

            for (let i = 1; i < gradeRow.childNodes.length; i++) {
                let className = headerRow.childNodes[i].getElementsByTagName('input')[0].value
                let gpaWeight = parseFloat(gpaRow.childNodes[i].getElementsByTagName('select')[0].value)
                totalGPAWeight += gpaWeight
                let grade = parseFloat(gradeRow.childNodes[i].getElementsByTagName('input')[0].value)
                sumOfGrades += (grade)
                let weightedSimple = gpaWeight*grade*0.01
                weightedSimples += weightedSimple
                let unweightedSimple = 4*grade*0.01
                unweightedSimples += unweightedSimple
            }

            let numberOfClasses = (gradeRow.childNodes.length-1)
            let allenISDSumOfGrades = -(sumOfGrades-(numberOfClasses*100))*0.05

            document.getElementById('simpleAverage').innerHTML = "Simple Average Weighted: "+(weightedSimples/numberOfClasses).toFixed(2)
            document.getElementById('simpleAverageUnweighted').innerHTML = "Simple Average Unweighted: "+(unweightedSimples/numberOfClasses).toFixed(2)
            document.getElementById('allenISDFormulaWeighted').innerHTML = "AllenISD Formula Weighted: "+(((totalGPAWeight-allenISDSumOfGrades)/numberOfClasses)).toFixed(2)
            document.getElementById('allenISDFormulaUnweighted').innerHTML = "AllenISD Formula Unweighted: "+((((4*numberOfClasses)-allenISDSumOfGrades)/numberOfClasses)).toFixed(2)

            createCookie("inputtedGPAValues", inputtedGPAValues, 365)
            createCookie("inputtedGradeValues", inputtedGradeValues, 365)
        }

        function createCookie(name, value, days) {
            var expires;
            if (days) {
                var date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toGMTString();
            }
            else {
                expires = "";
            }
            document.cookie = name + "=" + value + expires + "; path=/";
        }

        function getCookie(c_name) {
            if (document.cookie.length > 0) {
                c_start = document.cookie.indexOf(c_name + "=");
                if (c_start != -1) {
                    c_start = c_start + c_name.length + 1;
                    c_end = document.cookie.indexOf(";", c_start);
                    if (c_end == -1) {
                        c_end = document.cookie.length;
                    }
                    return unescape(document.cookie.substring(c_start, c_end));
                }
            }
            return "";
        }

        function setup() {
            let savedGPAsDropDown = document.getElementById('savedGPAsDropDown')
            var checkList = document.getElementById('semestersListItems');

            let testCookie = getCookie("savedGPAs")
            if(testCookie.includes("{") && testCookie.includes('}')) {
                savedGPAs = JSON.parse(testCookie)
            } else savedGPAs = {}
            console.log(savedGPAs)

            Object.keys(savedGPAs).forEach(gpa => {
                let newOption = document.createElement('option')
                newOption.id = gpa+"~~~"
                newOption.value = gpa
                newOption.innerHTML = gpa
                savedGPAsDropDown.appendChild(newOption)

                let newDropDown = document.createElement('li')
                newDropDown.id = gpa+"|||"
                let checkBox = document.createElement('input')
                checkBox.type = 'checkbox'
                newDropDown.appendChild(checkBox)
                let newSpan = document.createElement('span')
                newSpan.innerHTML = " "+gpa
                newDropDown.appendChild(newSpan)
                checkBox.onclick = function() {
                    if(checkBox.checked) selectedSemestersDropDown.push(gpa)
                    else selectedSemestersDropDown = selectedSemestersDropDown.filter(a=>a!==gpa)
                    var anchor = document.getElementsByClassName('anchor')[0]
                    anchor.innerHTML = selectedSemestersDropDown.length+" Selected Semester(s)";
                    updateOverallGPA();
                }
                checkList.appendChild(newDropDown)
            })

            classNames = getCookie('classNames') || []
            if (typeof classNames == 'string') classNames = classNames.split(',')
            inputtedGPAValues = getCookie('inputtedGPAValues') || []
            if (typeof inputtedGPAValues == 'string') inputtedGPAValues = inputtedGPAValues.split(',')
            inputtedGradeValues = getCookie('inputtedGradeValues') || []
            if (typeof inputtedGradeValues == 'string') inputtedGradeValues = inputtedGradeValues.split(',')

            setNumberOfClasses = getCookie('numOfClasses')
            if(setNumberOfClasses) setTable(setNumberOfClasses)
            else setTable(0)

            updateGPA()
        }
        
        function changeCurrentGPA(savedGPAName) {
            if(savedGPAName == 'None Selected') {}
            else if(savedGPAName == 'Add Blank') {
                classNames = []
                inputtedGPAValues = []
                inputtedGradeValues = []
                createCookie("classNames", classNames, 365)
                setTable(1)
                updateGPA()
                document.getElementById('InputtedGPAName').value = "";
            }
            else if(savedGPAs[savedGPAName]) {
                classNames = savedGPAs[savedGPAName].classNames
                inputtedGPAValues = savedGPAs[savedGPAName].inputtedGPAValues
                inputtedGradeValues = savedGPAs[savedGPAName].inputtedGradeValues
                createCookie("classNames", classNames, 365)
                setTable(savedGPAs[savedGPAName].setNumberOfClasses)
                updateGPA()
                document.getElementById('InputtedGPAName').value = savedGPAName;
            } else console.log("[ERROR] Cannot find that Saved GPA.")
        }

        function saveGPA() {
            let InputtedGPAName = document.getElementById('InputtedGPAName').value
            if(InputtedGPAName) {
                if(!savedGPAs[InputtedGPAName]) {
                    let savedGPAsDropDown = document.getElementById('savedGPAsDropDown')
                    var checkList = document.getElementById('semestersListItems');

                    let newOption = document.createElement('option')
                    newOption.value = InputtedGPAName
                    newOption.innerHTML = InputtedGPAName
                    newOption.id = InputtedGPAName+"~~~"
                    savedGPAsDropDown.appendChild(newOption)

                    let newDropDown = document.createElement('li')
                    newDropDown.id = InputtedGPAName+"|||"
                    let checkBox = document.createElement('input')
                    checkBox.type = 'checkbox'
                    checkBox.id = InputtedGPAName + 'id'
                    checkBox.onclick = function() {
                        if(checkBox.checked) selectedSemestersDropDown.push(InputtedGPAName)
                        else selectedSemestersDropDown = selectedSemestersDropDown.filter(a=>a!==InputtedGPAName)
                        var anchor = document.getElementsByClassName('anchor')[0]
                        anchor.innerHTML = selectedSemestersDropDown.length+" Selected Semester(s)"
                        updateOverallGPA()
                    }
                    newDropDown.appendChild(checkBox)
                    let newSpan = document.createElement('span')
                    newSpan.innerHTML = " "+InputtedGPAName
                    newDropDown.appendChild(newSpan)
                    checkList.appendChild(newDropDown)
                }
                console.log('InputtedGPAName: '+InputtedGPAName)
                console.log('typeof savedGPAs['+InputtedGPAName+']: '+ typeof savedGPAs[InputtedGPAName])
                savedGPAs[InputtedGPAName] = {
                    classNames: classNames.filter((a, i) => {
                        if(i+1 <= setNumberOfClasses) return true;
                        else return false;
                    }).map(a=>a),
                    inputtedGPAValues: inputtedGPAValues.filter((a, i) => {
                        if(i+1 <= setNumberOfClasses) return true;
                        else return false;
                    }).map(a=>a),
                    inputtedGradeValues: inputtedGradeValues.filter((a, i) => {
                        if(i+1 <= setNumberOfClasses) return true;
                        else return false;
                    }).map(a=>a),
                    setNumberOfClasses: setNumberOfClasses
                }
                console.log('typeof savedGPAs['+InputtedGPAName+']: '+ typeof savedGPAs[InputtedGPAName])
                console.log(savedGPAs)
                createCookie("savedGPAs", JSON.stringify(savedGPAs), 365)
            }
        }

        function deleteSemesterGPA() {
            let InputtedGPAName = document.getElementById('InputtedGPAName').value
            if(InputtedGPAName) {
                if(savedGPAs[InputtedGPAName]) {
                    delete savedGPAs[InputtedGPAName]
                    createCookie("savedGPAs", JSON.stringify(savedGPAs), 365)
                    changeCurrentGPA('None Selected')
                    checkBox = document.getElementById(InputtedGPAName + 'id')
                    selectedSemestersDropDown = selectedSemestersDropDown.filter(a=>a!==checkBox)
                    var anchor = document.getElementsByClassName('anchor')[0]
                    anchor.innerHTML = selectedSemestersDropDown.length+" Selected Semester(s)"
                    let savedGPAsDropDown = document.getElementById('savedGPAsDropDown')
                    var checkList = document.getElementById('semestersListItems');
                    let toRemove = document.getElementById(InputtedGPAName+"~~~")
                    let toRemove2 = document.getElementById(InputtedGPAName+"|||")
                    savedGPAsDropDown.removeChild(toRemove)
                    checkList.removeChild(toRemove2)
                    var opts = savedGPAsDropDown.options;
                    for (var opt, j = 0; opt = opts[j]; j++) {
                        if (opt.id == 'NoneSelected') {
                            savedGPAsDropDown.selectedIndex = j;
                        break;
                        }
                    }
                    document.getElementById('InputtedGPAName').value = ""
                }
            }
        }

        function toggleSemestersCheckList() {
            var checkList = document.getElementById('semestersList');
            var anchor = document.getElementsByClassName('anchor')[0]
            anchor.innerHTML = selectedSemestersDropDown.length+" Selected Semester(s)"
            if (checkList.classList.contains('visible'))
                checkList.classList.remove('visible');
            else
                checkList.classList.add('visible');
        }

        function updateOverallGPA() {
            let GPAWeights = [];
            let Grades = [];

            if(!selectedSemestersDropDown.length) {
                document.getElementById('simpleAverageTotal').innerHTML = "Overall Simple Average Weighted: 0.00"
                document.getElementById('simpleAverageUnweightedTotal').innerHTML = "Overall Simple Average Unweighted: 0.00"
                document.getElementById('allenISDFormulaWeightedTotal').innerHTML = "Overall AllenISD Formula Weighted: 0.00"
                document.getElementById('allenISDFormulaUnweightedTotal').innerHTML = "Overall AllenISD Formula Unweighted: 0.00"
                return;
            }

            selectedSemestersDropDown.forEach((savedSemesterName, i) => {
                if(savedGPAs[savedSemesterName]) {
                    for (let l = 0; l < parseInt(savedGPAs[savedSemesterName].setNumberOfClasses); l++) {
                        if(savedGPAs[savedSemesterName].inputtedGPAValues[l]) GPAWeights.push(savedGPAs[savedSemesterName].inputtedGPAValues[l])
                        else GPAWeights.push("4.0")

                        if(savedGPAs[savedSemesterName].inputtedGradeValues[l]) Grades.push(savedGPAs[savedSemesterName].inputtedGradeValues[l])
                        else Grades.push("0")
                    }
                } else {
                    // Maybe later incorporate some sort of error notification system.
                }
            })

            weightedSimples = 0;
            unweightedSimples = 0;
            sumOfGrades = 0;
            totalGPAWeight = 0;

            for (let i = 0; i < GPAWeights.length; i++) {
                totalGPAWeight += parseFloat(GPAWeights[i])
                sumOfGrades += (parseFloat(Grades[i]))
                let weightedSimple = parseFloat(GPAWeights[i])*(parseFloat(Grades[i]))*0.01
                weightedSimples += weightedSimple
                let unweightedSimple = 4*(parseFloat(Grades[i]))*0.01
                unweightedSimples += unweightedSimple
            }

            let numberOfClasses = GPAWeights.length;
            let allenISDSumOfGrades = -(sumOfGrades-(numberOfClasses*100))*0.05

            document.getElementById('simpleAverageTotal').innerHTML = "Overall Simple Average Weighted: "+(weightedSimples/numberOfClasses).toFixed(2)
            document.getElementById('simpleAverageUnweightedTotal').innerHTML = "Overall Simple Average Unweighted: "+(unweightedSimples/numberOfClasses).toFixed(2)
            document.getElementById('allenISDFormulaWeightedTotal').innerHTML = "Overall AllenISD Formula Weighted: "+(((totalGPAWeight-allenISDSumOfGrades)/numberOfClasses)).toFixed(2)
            document.getElementById('allenISDFormulaUnweightedTotal').innerHTML = "Overall AllenISD Formula Unweighted: "+((((4*numberOfClasses)-allenISDSumOfGrades)/numberOfClasses)).toFixed(2)
            
        }
		
		
    </script>

   <body onload="setup()">

    <h1>Calculate Your GPA:</h1>

    <h2>How many classes do you have?</h2>
    <input id="sliderrange" type="range" min="1" max="10" value="7" oninput="setTable(this.value)">
    <input id="numrange" type="number" min=1 max=10 value="7" step="1" oninput="setTable(this.value)">

    <h2>Saved GPAs:</h2>
    <div class="select" style="width: 25vw;">
        <select id="savedGPAsDropDown" oninput="changeCurrentGPA(this.value)">
            <option value="None Selected" id="NoneSelected" selected disabled hidden>None Selected</option>
            <option value="Add Blank" id="CreateBlank">Create Blank</option>
        </select>
    </div>

    <div class="holder">
        <div class="GPAInputDiv">
            <table class="GPACalculator">
                <tr id="classListRow">
                    <th style="border-top: none; border-left: none;"></th>
                    <th>Class 1</th>
                </tr>
                <tr id="gpaSelectRow">
                    <th>GPA Weight:</th>
                </tr>
                <tr id="gradeInputRow">
                    <th>Current Grades:</th>
                </tr>
            </table>
        </div>

        <div class="resultsBox row">
            <div class="column">
                <h2><strong>GPA:</strong></h2>
                <h4 id="simpleAverage">Simple Average Weighted: </h4>
                <h4 id="simpleAverageUnweighted">Simple Average Unweighted: </h4>
                <h4 id="allenISDFormulaWeighted">AllenISD Formula Weighted: </h4>
                <h4 id="allenISDFormulaUnweighted">AllenISD Formula Unweighted: </h4>
                <span>
                    <input type="text" placeholder="Semester 1" id="InputtedGPAName"></input>
                    <button onclick="saveGPA()">Save Semester GPA</button>
                    <button onclick="deleteSemesterGPA()">Delete Inputted Semester GPA</button>
                </span>
            </div>
            <div class="column" style="margin-left: -1px;">
                <h2><strong>Overall GPA:</strong></h2>
                <div id="semestersList" class="dropdown-check-list" tabindex="100">
                    <span class="anchor" onclick="toggleSemestersCheckList()">Select Semester(s)</span>
                    <ul class="items" id="semestersListItems">
                    </ul>
                </div>
                <h4 id="simpleAverageTotal">Overall Simple Average Weighted: </h4>
                <h4 id="simpleAverageUnweightedTotal">Overall Simple Average Unweighted: </h4>
                <h4 id="allenISDFormulaWeightedTotal">Overall AllenISD Formula Weighted: </h4>
                <h4 id="allenISDFormulaUnweightedTotal">Overall AllenISD Formula Unweighted: </h4>
            </div>
        </div>
    </div>

   </body>
</html>
