<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>GPA Calculator</title>
      <link rel="stylesheet" href="index.css">
   </head>

   <script>
        let classNames = [];
        let inputtedGPAValues = [];
        let inputtedGradeValues = [];
        let setNumberOfClasses = 7;

        function setTable(numberOfClasses) {
            setNumberOfClasses = numberOfClasses
            document.getElementById('numrange').value = numberOfClasses
            document.getElementById('sliderrange').value = numberOfClasses
            createCookie("numOfClasses", setNumberOfClasses, 365)

            let headerRow = document.getElementById('classListRow')
            let gpaRow = document.getElementById('gpaSelectRow')
            let gradeRow = document.getElementById('gradeInputRow')

            headerRow.innerHTML = ''
            gpaRow.innerHTML = ''
            gradeRow.innerHTML = ''

            let corner = document.createElement('th')
            corner.style.borderTop = 'none';
            corner.style.borderLeft = 'none';
            headerRow.appendChild(corner)

            let titleOfGPARow = document.createElement('th')
            titleOfGPARow.innerHTML = 'GPA Weight:'
            gpaRow.appendChild(titleOfGPARow)


            let titleOfGradeRow = document.createElement('th')
            titleOfGradeRow.innerHTML = 'Current Grades:'
            titleOfGradeRow.id = "fittext"
            gradeRow.appendChild(titleOfGradeRow)

            for (let i = 0; i < parseInt(numberOfClasses); i++) {
                // Header (Class 1)
                let headerTH = document.createElement('th')
                let headerInput = document.createElement('input')
                headerInput.className = 'headerClassName'
                headerInput.type = 'text'
                if(!classNames[i]) headerInput.value = 'Class '+Math.floor(i+1)
                else headerInput.value = classNames[i]
                headerInput.onchange = function() {
                    classNames[i] = headerInput.value
                }
                headerTH.appendChild(headerInput)
                headerRow.appendChild(headerTH)

                // DropDown (5.0)
                let dropDownTD = document.createElement('td')

                let gpaSelector = document.createElement('div')
                gpaSelector.className = "select"

                dropDownTD.appendChild(gpaSelector)
                
                let select = document.createElement('select')
                let options = ['4.0', '4.5', '5.0']
                options.forEach(value => {
                    let opt = document.createElement('option')
                    opt.value = value
                    opt.innerHTML = value
                    select.appendChild(opt)
                });

                select.onchange = function() {
                    inputtedGPAValues[i] = select.value
                    updateGPA()
                }

                if(inputtedGPAValues[i]) select.value = inputtedGPAValues[i]
                
                let arrow = document.createElement('div')
                arrow.className = 'select__arrow'

                gpaSelector.appendChild(select)
                gpaSelector.appendChild(arrow)
                gpaRow.appendChild(dropDownTD)

                // GradeInput (0-100)
                let gradeInputTD = document.createElement('td')
                
                let gradeInput = document.createElement('input')
                gradeInput.className = "gradeInput"
                gradeInput.type = 'number'
                gradeInput.min = 0;
                gradeInput.max = 100;
                gradeInput.value = 0;
                gradeInput.step = 0.5

                if(inputtedGradeValues[i]) gradeInput.value = inputtedGradeValues[i]

                gradeInput.onchange = function() {
                    inputtedGradeValues[i] = gradeInput.value
                    updateGPA()
                }

                gradeInputTD.appendChild(gradeInput)
                gradeRow.appendChild(gradeInputTD)
            }
        }

        function updateGPA() {
            weightedSimples = 0;
            unweightedSimples = 0;
            sumOfGrades = 0;
            totalGPAWeight = 0;
            let headerRow = document.getElementById('classListRow')
            let gpaRow = document.getElementById('gpaSelectRow')
            let gradeRow = document.getElementById('gradeInputRow')

            for (let i = 1; i < gradeRow.childNodes.length; i++) {
                let className = headerRow.childNodes[i].getElementsByTagName('input')[0].value
                let gpaWeight = parseFloat(gpaRow.childNodes[i].getElementsByTagName('select')[0].value)
                totalGPAWeight += gpaWeight
                let grade = parseFloat(gradeRow.childNodes[i].getElementsByTagName('input')[0].value)
                sumOfGrades += (grade)
                let weightedSimple = gpaWeight*grade*0.01
                weightedSimples += weightedSimple
                let unweightedSimple = 4*grade*0.01
                unweightedSimples += unweightedSimple
            }

            let numberOfClasses = (gradeRow.childNodes.length-1)
            let allenISDSumOfGrades = -(sumOfGrades-(numberOfClasses*100))*0.05

            document.getElementById('simpleAverage').innerHTML = "Simple Average Weighted: "+(weightedSimples/numberOfClasses).toFixed(2)
            document.getElementById('simpleAverageUnweighted').innerHTML = "Simple Average Weighted: "+(unweightedSimples/numberOfClasses).toFixed(2)
            document.getElementById('allenISDFormulaWeighted').innerHTML = "Simple Average Weighted: "+(((totalGPAWeight-allenISDSumOfGrades)/numberOfClasses)).toFixed(2)
            document.getElementById('allenISDFormulaUnweighted').innerHTML = "Simple Average Weighted: "+((((4*numberOfClasses)-allenISDSumOfGrades)/numberOfClasses)).toFixed(2)

            createCookie("classNames", classNames, 365)
            createCookie("inputtedGPAValues", inputtedGPAValues, 365)
            createCookie("inputtedGradeValues", inputtedGradeValues, 365)
        }

        function createCookie(name, value, days) {
            var expires;
            if (days) {
                var date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toGMTString();
            }
            else {
                expires = "";
            }
            document.cookie = name + "=" + value + expires + "; path=/";
        }

        function getCookie(c_name) {
            if (document.cookie.length > 0) {
                c_start = document.cookie.indexOf(c_name + "=");
                if (c_start != -1) {
                    c_start = c_start + c_name.length + 1;
                    c_end = document.cookie.indexOf(";", c_start);
                    if (c_end == -1) {
                        c_end = document.cookie.length;
                    }
                    return unescape(document.cookie.substring(c_start, c_end));
                }
            }
            return "";
        }

        function setup() {
            classNames = getCookie('classNames') || []
            if (typeof classNames == 'string') classNames = classNames.split(',')
            inputtedGPAValues = getCookie('inputtedGPAValues') || []
            if (typeof inputtedGPAValues == 'string') inputtedGPAValues = inputtedGPAValues.split(',')
            inputtedGradeValues = getCookie('inputtedGradeValues') || []
            if (typeof inputtedGradeValues == 'string') inputtedGradeValues = inputtedGradeValues.split(',')

            setNumberOfClasses = getCookie('numOfClasses')
            console.log(setNumberOfClasses)
            if(setNumberOfClasses) setTable(setNumberOfClasses)
            else setTable(7)

            updateGPA()
        }
    </script>

   <body onload="setup()">

    <h1>Calculate Your GPA:</h1>

    <h2>How many classes do you have?</h2>
    <input id="sliderrange" type="range" min="1" max="10" value="7" oninput="setTable(this.value)">
    <input id="numrange" type="number" min=1 max=10 value="7" step="1" oninput="setTable(this.value)">

    <div class="holder">
        <div class="GPAInputDiv">
            <table class="GPACalculator">
                <tr id="classListRow">
                    <th style="border-top: none; border-left: none;"></th>
                    <th>Class 1</th>
                </tr>
                <tr id="gpaSelectRow">
                    <th>GPA Weight:</th>
                </tr>
                <tr id="gradeInputRow">
                    <th>Current Grades:</th>
                </tr>
            </table>
        </div>

        <div class="resultsBox">
            <h2><strong>GPA:</strong></h2>
            <h4 id="simpleAverage">Simple Average Weighted: </h4>
            <h4 id="simpleAverageUnweighted">Simple Average Unweighted: </h4>
            <h4 id="allenISDFormulaWeighted">AllenISD Formula Weighted: </h4>
            <h4 id="allenISDFormulaUnweighted">AllenISD Formula Unweighted: </h4>
        </div>
    </div>

   </body>
</html>